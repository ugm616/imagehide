<script>
    let originalImageData;
    let encryptedImageData;

    function loadImage(file) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = URL.createObjectURL(file);
        });
    }

    function getImageData(img) {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        return ctx.getImageData(0, 0, img.width, img.height);
    }

    function generateKey(length) {
        const key = new Uint8Array(length);
        for (let i = 0; i < length; i++) {
            key[i] = Math.floor(Math.random() * 256);
        }
        return key;
    }

    function keyToString(key) {
        return Array.from(key).map(byte => byte.toString(16).padStart(2, '0')).join('');
    }

    function stringToKey(str) {
        const key = new Uint8Array(str.length / 2);
        for (let i = 0; i < key.length; i++) {
            key[i] = parseInt(str.substr(i * 2, 2), 16);
        }
        return key;
    }

    function applyXOR(data, key) {
        const result = new Uint8ClampedArray(data.length);
        for (let i = 0; i < data.length; i++) {
            result[i] = data[i] ^ key[i % key.length];
        }
        return result;
    }

    function displayImage(imageData) {
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        ctx.putImageData(imageData, 0, 0);
    }

    async function encryptImage() {
        const fileInput = document.getElementById('upload');
        if (fileInput.files.length === 0) {
            alert('Please upload an image!');
            return;
        }

        const img = await loadImage(fileInput.files[0]);
        originalImageData = getImageData(img);
        const key = generateKey(originalImageData.data.length);
        const encryptedData = applyXOR(originalImageData.data, key);
        encryptedImageData = new ImageData(encryptedData, originalImageData.width, originalImageData.height);
        displayImage(encryptedImageData);

        // Store encrypted image data in local storage
        localStorage.setItem('encryptedImageData', JSON.stringify(encryptedData));
        localStorage.setItem('imageWidth', encryptedImageData.width);
        localStorage.setItem('imageHeight', encryptedImageData.height);
        document.getElementById('keyBox').value = keyToString(key);
    }

    function decryptImage() {
        const keyStr = document.getElementById('keyBox').value;
        if (!keyStr) {
            alert('No encrypted image or key provided!');
            return;
        }

        // Retrieve encrypted image data from local storage
        const encryptedDataStr = localStorage.getItem('encryptedImageData');
        const imageWidth = localStorage.getItem('imageWidth');
        const imageHeight = localStorage.getItem('imageHeight');

        if (!encryptedDataStr || !imageWidth || !imageHeight) {
            alert('No encrypted image or key provided!');
            return;
        }

        const encryptedData = new Uint8ClampedArray(JSON.parse(encryptedDataStr));
        const key = stringToKey(keyStr);
        const decryptedData = applyXOR(encryptedData, key);
        const decryptedImageData = new ImageData(decryptedData, parseInt(imageWidth), parseInt(imageHeight));
        displayImage(decryptedImageData);
    }

    function copyKey() {
        const keyBox = document.getElementById('keyBox');
        keyBox.select();
        document.execCommand('copy');
    }

    function pasteKey() {
        const keyBox = document.getElementById('keyBox');
        navigator.clipboard.readText().then(text => {
            keyBox.value = text;
        }).catch(err => {
            console.error('Failed to read clipboard contents: ', err);
            alert('Failed to read clipboard contents. Please make sure you have granted clipboard permissions.');
        });
    }
</script>
